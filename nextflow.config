// ============================================================
// nextflow.config  –  Ordination pipeline
// ============================================================

// ── Pipeline parameters (override with --param value on CLI) ─
params {
    // ── Required ──────────────────────────────────────────────
    // Directory containing counts CSVs, one per taxonomic level.
    // Both filtered and unfiltered naming conventions are supported:
    //   filtered_ancom_count_input_<level>.csv
    //   ancom_count_input_<level>.csv
    input_dir       = null

    // Path to sample metadata CSV (rows = samples, must contain
    // a 'group' column with values e.g. PD / control)
    metadata        = null

    // ── Output ────────────────────────────────────────────────
    // Results are written to <output_dir>/<level>/{aitchison_pca,rpca_deicode}/
    output_dir      = "results"

    // ── Reproducibility ───────────────────────────────────────
    seed            = 42
}

// ── Execution profiles ───────────────────────────────────────
profiles {

    // docker: run every process inside the microbe-comm-struct Docker image.
    // On ARM64 hosts (DGX Spark), register QEMU first:
    //   docker run --privileged --rm tonistiigi/binfmt --install x86_64
    docker {
        docker.enabled    = true
        docker.runOptions = "-v ${projectDir}:/workspace"

        process {
            container = "microbe-comm-struct:latest"

            cpus   = 2
            memory = "4 GB"
            time   = "1 h"

            withName: 'AITCHISON_PCA' {
                cpus   = 2
                memory = "8 GB"
                time   = "30 min"
            }

            withName: 'RPCA_DEICODE' {
                cpus   = 2
                memory = "16 GB"
                time   = "30 min"
            }
        }
    }

    // local: skip Docker (assumes R + all packages are installed locally)
    local {
        docker.enabled   = false
        process.executor = 'local'
    }

    // sge: submit to BU SCC (SGE) cluster via Singularity.
    //
    // Image is built automatically on every push to main via GitHub Actions
    // and pulled from: ghcr.io/bu-neuromics/microbe-comm-struct:latest
    //
    // Run:
    //   ./run_pipeline.sh --input_dir data/filtered/ --metadata metadata.csv -profile sge
    sge {
        process.executor       = 'sge'
        singularity.enabled    = true
        singularity.autoMounts = true

        process {
            container      = "docker://ghcr.io/bu-neuromics/microbe-comm-struct:latest"
            clusterOptions = "-P bubhub"
            penv           = "omp"
            cpus           = 4
            memory         = "16 GB"
            time           = "1 h"

            withName: 'AITCHISON_PCA' {
                cpus   = 4
                memory = "16 GB"
                time   = "30 min"
            }

            withName: 'RPCA_DEICODE' {
                cpus   = 4
                memory = "32 GB"
                time   = "30 min"
            }
        }
    }
}

// ── Nextflow reporting ───────────────────────────────────────
report {
    enabled   = true
    overwrite = true
    file      = "${params.output_dir}/pipeline_report.html"
}

timeline {
    enabled   = true
    overwrite = true
    file      = "${params.output_dir}/pipeline_timeline.html"
}

trace {
    enabled   = true
    file      = "${params.output_dir}/pipeline_trace.txt"
    overwrite = true
    fields    = 'task_id,name,status,exit,realtime,cpus,%cpu,memory,%mem,rss'
}

dag {
    enabled = true
    file    = "${params.output_dir}/pipeline_dag.html"
}
